# Test Utilities

Angular ships dedicated testing packages and internal helpers that power its test infrastructure.

## @angular/core/testing

The primary testing module:

```typescript
// packages/core/testing/src/test_bed.ts
export class TestBed {
  static configureTestingModule(moduleDef: TestModuleMetadata): typeof TestBed;
  static createComponent<T>(component: Type<T>): ComponentFixture<T>;
  static inject<T>(token: ProviderToken<T>): T;
  static overrideProvider(token: any, provider: ValueProvider): typeof TestBed;
  static resetTestingModule(): typeof TestBed;
}
```

### fakeAsync / tick / flush

Zone.js-based async control:

```typescript
// packages/core/testing/src/fake_async.ts
import {fakeAsync, tick, flush, flushMicrotasks} from '@angular/core/testing';

it('handles timers', fakeAsync(() => {
  let count = 0;
  setInterval(() => count++, 1000);

  tick(3000);
  expect(count).toBe(3);

  // Or flush all pending timers
  flush();
}));
```

### ComponentFixture

The test wrapper for components:

```typescript
// packages/core/testing/src/component_fixture.ts
export class ComponentFixture<T> {
  componentInstance: T;         // The component class instance
  debugElement: DebugElement;   // Rich query API
  nativeElement: HTMLElement;   // Raw DOM element
  changeDetectorRef: ChangeDetectorRef;

  detectChanges(): void;        // Trigger change detection
  whenStable(): Promise<any>;   // Wait for async operations
  destroy(): void;              // Cleanup
}
```

## @angular/common/http/testing

HTTP mock infrastructure:

```typescript
// packages/common/http/testing/src/api.ts
export class HttpTestingController {
  // Expect exactly one request matching URL
  expectOne(url: string | RequestMatch): TestRequest;

  // Expect exactly N requests matching
  match(url: string | RequestMatch): TestRequest[];

  // Assert no outstanding requests
  verify(): void;
}

export class TestRequest {
  request: HttpRequest<any>;

  // Respond with data
  flush(body: any, opts?: {status?: number; headers?: HttpHeaders}): void;

  // Respond with error
  error(error: ProgressEvent, opts?: {status?: number}): void;
}
```

## @angular/router/testing

Router test utilities:

```typescript
// packages/router/testing/src/router_testing_module.ts
export class RouterTestingModule {
  static withRoutes(routes: Routes): ModuleWithProviders<RouterTestingModule>;
}
```

Provides `SpyLocation` and in-memory router state â€” no real URL changes.

## @angular/cdk/testing

Component harness infrastructure:

```typescript
// cdk/testing/component-harness.ts
export abstract class ComponentHarness {
  protected locatorFor(selector: string): AsyncFactoryFn<TestElement>;
  protected locatorForOptional(selector: string): AsyncFactoryFn<TestElement | null>;
  protected locatorForAll(selector: string): AsyncFactoryFn<TestElement[]>;

  // Get child harness
  protected getHarness<T extends ComponentHarness>(
    query: HarnessQuery<T>
  ): Promise<T>;
}

export class HarnessLoader {
  getHarness<T extends ComponentHarness>(query: HarnessQuery<T>): Promise<T>;
  getAllHarnesses<T extends ComponentHarness>(query: HarnessQuery<T>): Promise<T[]>;
  getChildLoader(selector: string): Promise<HarnessLoader>;
}
```

## Internal Test Helpers

Helpers found across the Angular monorepo:

### DOM Assertion Helpers

```typescript
// packages/core/test/render3/instructions/shared_spec.ts
function getRenderedHtml(component: Type<any>): string {
  const fixture = TestBed.createComponent(component);
  fixture.detectChanges();
  return fixture.nativeElement.innerHTML;
}

function expectDomToMatch(actual: string, expected: string): void {
  // Normalize whitespace and attribute order
  const normalize = (html: string) =>
    html.replace(/\s+/g, ' ').trim();
  expect(normalize(actual)).toBe(normalize(expected));
}
```

### Async Helpers

```typescript
// packages/core/test/util_spec.ts
async function whenAllStable(fixtures: ComponentFixture<any>[]): Promise<void> {
  await Promise.all(fixtures.map(f => f.whenStable()));
}

function advanceTimers(ms: number): void {
  tick(ms);
  // Also flush any microtasks generated by timers
  flushMicrotasks();
}
```

### Signal Testing (Angular 16+)

```typescript
// packages/core/test/signals/signal_spec.ts
import {signal, computed, effect} from '@angular/core';

describe('signal', () => {
  it('should track dependencies', () => {
    const count = signal(0);
    const doubled = computed(() => count() * 2);

    expect(doubled()).toBe(0);

    count.set(5);
    expect(doubled()).toBe(10);
  });

  it('should notify effects', () => {
    const name = signal('Angular');
    const log: string[] = [];

    TestBed.runInInjectionContext(() => {
      effect(() => {
        log.push(name());
      });
    });

    TestBed.flushEffects();
    expect(log).toEqual(['Angular']);

    name.set('Signals');
    TestBed.flushEffects();
    expect(log).toEqual(['Angular', 'Signals']);
  });
});
```
